<div class="container">
  <div class="tax-return-detail">
    <div class="header">
      <div class="back-link">
        <%= link_to "â† Back to Tax Returns", tax_returns_path %>
      </div>
      <h1><%= @tax_return.tax_year.label %></h1>
      <p class="status-badge">
        Status: <span class="status status-<%= @tax_return.status %>"><%= @tax_return.status.titleize %></span>
      </p>
    </div>

    <div class="content">
      <div class="tabs">
        <a href="#overview" class="tab-button active" data-tab="overview">Overview</a>
        <a href="#evidence" class="tab-button" data-tab="evidence">Evidence</a>
        <a href="#validations" class="tab-button" data-tab="validations">Validations</a>
        <a href="#calculations" class="tab-button" data-tab="calculations">Calculations</a>
        <a href="#exports" class="tab-button" data-tab="exports">Exports</a>
        <a href="#settings" class="tab-button" data-tab="settings">Settings</a>
      </div>

      <div id="overview" class="tab-content active">
        <div class="section">
          <h2>Tax Return Details</h2>
          <div class="details-grid">
            <div class="detail-item">
              <label>Tax Year</label>
              <p><%= @tax_return.tax_year.label %></p>
            </div>
            <div class="detail-item">
              <label>Status</label>
              <p><span class="status status-<%= @tax_return.status %>"><%= @tax_return.status.titleize %></span></p>
            </div>
            <div class="detail-item">
              <label>Created</label>
              <p><%= @tax_return.created_at.strftime("%d %b %Y at %H:%M") %></p>
            </div>
            <div class="detail-item">
              <label>Box Values</label>
              <p><%= @tax_return.box_values.count %> entered</p>
            </div>
          </div>
        </div>

        <div class="section">
          <h2>Quick Actions</h2>
          <div class="actions">
            <%= link_to "Upload Evidence", new_evidence_path(tax_return_id: @tax_return.id), class: "btn btn-primary" %>
            <%= link_to "Run Validations", tax_return_validations_path(@tax_return), class: "btn btn-secondary" %>
            <%= link_to "View Calculations", tax_return_calculations_path(@tax_return), class: "btn btn-secondary" %>
            <%= link_to "Review & Export", "/tax_returns/#{@tax_return.id}/exports/review", class: "btn btn-primary" %>
          </div>
        </div>
      </div>

      <div id="evidence" class="tab-content">
        <div class="section">
          <h2>Evidence Files</h2>
          <% blank_forms = @tax_return.evidences.where(evidence_type: "blank_form") %>
          <% supporting_docs = @tax_return.evidences.where(evidence_type: "supporting_document") %>

          <% if @tax_return.evidences.any? %>
            <% if blank_forms.any? %>
              <div class="evidence-category">
                <h3>ðŸ“„ Blank Tax Forms (<%= blank_forms.count %>)</h3>
                <div class="evidence-list">
                  <% blank_forms.each do |evidence| %>
                    <div class="evidence-item">
                      <div class="evidence-info">
                        <p><strong><%= evidence.filename || "Blank Form" %></strong></p>
                        <p class="text-muted">Uploaded: <%= evidence.created_at.strftime("%d %b %Y") %></p>
                      </div>
                      <div class="evidence-actions">
                        <%= link_to "View", evidence_path(evidence), class: "link-btn" %>
                      </div>
                    </div>
                  <% end %>
                </div>
              </div>
            <% end %>

            <% if supporting_docs.any? %>
              <div class="evidence-category">
                <h3>ðŸ“Ž Supporting Documents (<%= supporting_docs.count %>)</h3>
                <div class="evidence-list">
                  <% supporting_docs.each do |evidence| %>
                    <div class="evidence-item">
                      <div class="evidence-info">
                        <p><strong><%= evidence.filename || "Supporting Document" %></strong></p>
                        <p class="text-muted">Uploaded: <%= evidence.created_at.strftime("%d %b %Y") %></p>
                      </div>
                      <div class="evidence-actions">
                        <%= link_to "View", evidence_path(evidence), class: "link-btn" %>
                      </div>
                    </div>
                  <% end %>
                </div>
              </div>
            <% end %>
          <% else %>
            <p class="empty-message">No evidence files uploaded yet</p>
          <% end %>
          <%= link_to "Upload More Evidence", new_evidence_path(tax_return_id: @tax_return.id), class: "btn btn-primary" %>
        </div>
      </div>

      <div id="validations" class="tab-content">
        <div class="section">
          <h2>Validations</h2>
          <p><%= link_to "Run Validations", tax_return_validations_path(@tax_return), class: "btn btn-primary" %></p>
        </div>
      </div>

      <div id="calculations" class="tab-content">
        <div class="section">
          <h2>Tax Calculations</h2>
          <p><%= link_to "View Calculations", tax_return_calculations_path(@tax_return), class: "btn btn-primary" %></p>
        </div>
      </div>

      <div id="exports" class="tab-content">
        <div class="section">
          <h2>Exports</h2>
          <p><%= link_to "Review & Generate New Export", "/tax_returns/#{@tax_return.id}/exports/review", class: "btn btn-primary" %></p>

          <% if @tax_return.exports.any? %>
            <div class="exports-list">
              <h3 style="margin-top: 1.5rem; margin-bottom: 1rem;">Previous Exports</h3>
              <% @tax_return.exports.each do |export| %>
                <div class="export-item">
                  <p><strong>Export #<%= export.id %></strong></p>
                  <p class="text-muted">Generated: <%= export.exported_at.strftime("%d %b %Y at %H:%M") %></p>
                  <div class="export-actions">
                    <% if export.file_path.present? %>
                      <%= link_to "PDF", download_pdf_tax_return_export_path(@tax_return, export), class: "link-btn" %>
                    <% end %>
                    <% if export.json_path.present? %>
                      <%= link_to "JSON", download_json_tax_return_export_path(@tax_return, export), class: "link-btn" %>
                    <% end %>
                  </div>
                </div>
              <% end %>
            </div>
          <% else %>
            <p class="empty-message">No exports yet. Start by reviewing your data and generating an export.</p>
          <% end %>
        </div>
      </div>

      <div id="settings" class="tab-content">
        <div class="section">
          <h2>Calculator Settings</h2>
          <p class="settings-description">Select which tax calculations are relevant to your tax return.</p>

          <%= form_with url: update_calculator_settings_tax_return_path(@tax_return), method: :patch, local: true do |f| %>
            <div class="calculators-grid">
              <% TaxReturn::AVAILABLE_CALCULATORS.each do |code, label| %>
                <div class="calculator-card">
                  <div class="calculator-header">
                    <input
                      type="checkbox"
                      name="calculators[]"
                      value="<%= code %>"
                      id="calculator_<%= code %>"
                      <%= 'checked' if @tax_return.calculator_enabled?(code) %>
                      class="calculator-checkbox"
                    />
                    <label for="calculator_<%= code %>" class="calculator-label"><%= label %></label>
                  </div>
                  <div class="calculator-description">
                    <% description_map = {
                      ftcr: "Relief for furnished holiday accommodation. Only if you rent out furnished holiday properties.",
                      gift_aid: "Tax relief on charitable donations. Enable if you made charitable contributions.",
                      hicbc: "High Income Child Benefit Charge. Only applies if you have income over Â£50,000."
                    } %>
                    <p><%= description_map[code] %></p>
                  </div>
                </div>
              <% end %>
            </div>

            <div class="settings-actions">
              <%= f.submit "Save Settings", class: "btn btn-primary" %>
              <%= link_to "Cancel", tax_return_path(@tax_return), class: "btn btn-secondary" %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  .container {
    background-color: #f5f7fa;
    min-height: 100vh;
    padding: 1rem;
  }

  .tax-return-detail {
    max-width: 1000px;
    margin: 0 auto;
  }

  .header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 2rem;
    border-radius: 8px;
    margin-bottom: 2rem;
  }

  .back-link {
    margin-bottom: 1rem;
  }

  .back-link a {
    color: white;
    text-decoration: none;
    opacity: 0.9;
  }

  .back-link a:hover {
    opacity: 1;
    text-decoration: underline;
  }

  .header h1 {
    font-size: 2rem;
    margin-bottom: 0.5rem;
  }

  .status-badge {
    font-size: 0.95rem;
  }

  .content {
    background-color: white;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    overflow: hidden;
  }

  .tabs {
    display: flex;
    border-bottom: 2px solid #eee;
    background-color: #f8f9fa;
  }

  .tab-button {
    flex: 1;
    padding: 1rem;
    text-align: center;
    cursor: pointer;
    background: none;
    border: none;
    font-size: 0.95rem;
    color: #666;
    text-decoration: none;
    transition: all 0.3s;
    border-bottom: 3px solid transparent;
    margin-bottom: -2px;
  }

  .tab-button:hover {
    background-color: white;
    color: #667eea;
  }

  .tab-button.active {
    color: #667eea;
    border-bottom-color: #667eea;
    background-color: white;
  }

  .tab-content {
    display: none;
    padding: 2rem;
  }

  .tab-content.active {
    display: block;
  }

  .section {
    margin-bottom: 2rem;
  }

  .section:last-child {
    margin-bottom: 0;
  }

  .section h2 {
    font-size: 1.3rem;
    margin-bottom: 1.5rem;
    color: #333;
  }

  .details-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
  }

  .detail-item {
    padding: 1rem;
    background-color: #f8f9fa;
    border-radius: 4px;
  }

  .detail-item label {
    display: block;
    font-size: 0.85rem;
    color: #666;
    margin-bottom: 0.5rem;
    font-weight: 600;
  }

  .detail-item p {
    font-size: 0.95rem;
    color: #333;
  }

  .status {
    display: inline-block;
    padding: 0.4rem 0.8rem;
    border-radius: 4px;
    font-size: 0.85rem;
    font-weight: 600;
  }

  .status-draft {
    background-color: #ffeaa7;
    color: #d63031;
  }

  .actions {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
  }

  .btn {
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 4px;
    font-weight: 600;
    cursor: pointer;
    text-decoration: none;
    display: inline-block;
    transition: all 0.3s;
  }

  .btn-primary {
    background-color: #667eea;
    color: white;
  }

  .btn-primary:hover {
    background-color: #5568d3;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
  }

  .btn-secondary {
    background-color: #e9ecef;
    color: #333;
  }

  .btn-secondary:hover {
    background-color: #dee2e6;
  }

  .evidence-category {
    margin-bottom: 2rem;
  }

  .evidence-category h3 {
    font-size: 1rem;
    color: #333;
    margin-bottom: 1rem;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #dee2e6;
  }

  .evidence-list,
  .exports-list {
    border: 1px solid #eee;
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 1rem;
  }

  .evidence-item,
  .export-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 1rem;
    border-bottom: 1px solid #eee;
  }

  .evidence-item:last-child,
  .export-item:last-child {
    border-bottom: none;
  }

  .evidence-info,
  .export-info {
    flex: 1;
  }

  .evidence-info p,
  .export-info p {
    margin: 0.25rem 0;
  }

  .text-muted {
    font-size: 0.85rem;
    color: #999;
  }

  .evidence-actions,
  .export-actions {
    display: flex;
    gap: 0.5rem;
  }

  .link-btn {
    padding: 0.5rem 1rem;
    background-color: #667eea;
    color: white;
    border-radius: 4px;
    text-decoration: none;
    font-size: 0.9rem;
    transition: background-color 0.3s;
  }

  .link-btn:hover {
    background-color: #5568d3;
  }

  .empty-message {
    color: #999;
    font-style: italic;
    margin-bottom: 1rem;
  }

  .settings-description {
    color: #666;
    margin-bottom: 1.5rem;
    font-size: 0.95rem;
  }

  .calculators-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 1.5rem;
    margin-bottom: 2rem;
  }

  .calculator-card {
    border: 1px solid #ddd;
    border-radius: 6px;
    padding: 1.5rem;
    background-color: #fafbfc;
    transition: all 0.3s;
  }

  .calculator-card:hover {
    border-color: #667eea;
    box-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
  }

  .calculator-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
  }

  .calculator-checkbox {
    width: 20px;
    height: 20px;
    cursor: pointer;
    accent-color: #667eea;
  }

  .calculator-label {
    font-weight: 600;
    color: #333;
    cursor: pointer;
    flex: 1;
  }

  .calculator-description {
    margin-left: 2.5rem;
    padding-left: 0;
  }

  .calculator-description p {
    font-size: 0.85rem;
    color: #666;
    line-height: 1.4;
    margin: 0;
  }

  .settings-actions {
    display: flex;
    gap: 1rem;
  }

  @media (max-width: 768px) {
    .tabs {
      flex-wrap: wrap;
    }

    .tab-button {
      flex: 1 0 50%;
    }

    .evidence-item,
    .export-item {
      flex-direction: column;
      align-items: flex-start;
    }

    .evidence-actions,
    .export-actions {
      margin-top: 1rem;
      width: 100%;
    }

    .calculators-grid {
      grid-template-columns: 1fr;
    }

    .settings-actions {
      flex-direction: column;
    }

    .settings-actions .btn {
      width: 100%;
      text-align: center;
    }
  }
</style>

<script>
  document.querySelectorAll('.tab-button').forEach(button => {
    button.addEventListener('click', function(e) {
      e.preventDefault();
      const tabId = this.getAttribute('data-tab');

      // Hide all tabs
      document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
      });

      // Remove active class from all buttons
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
      });

      // Show selected tab
      document.getElementById(tabId).classList.add('active');
      this.classList.add('active');
    });
  });
</script>
