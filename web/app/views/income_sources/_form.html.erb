<%= form_with model: income_source,
              url: income_source.persisted? ?
                   tax_return_income_source_path(@tax_return, income_source) :
                   tax_return_income_sources_path(@tax_return),
              method: income_source.persisted? ? :patch : :post,
              local: true, class: "form-container" do |f| %>

  <% if income_source.errors.any? %>
    <div class="error-box">
      <h3><%= pluralize(income_source.errors.count, "error") %> prohibited this income source from being saved:</h3>
      <ul>
        <% income_source.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="form-group">
    <%= f.label :source_type, "Income Type" %>
    <%= f.select :source_type,
                 IncomeSource.source_types.keys.map { |k| [k.titleize, k] },
                 { prompt: "Select income type" },
                 { class: "form-control", required: true } %>
    <small class="text-muted">e.g., Employment, Self-employment, Dividends, Interest, Pension</small>
  </div>

  <div class="form-group">
    <%= f.label :currency, "Currency" %>
    <%= f.select :currency,
                 ['GBP', 'EUR', 'USD'],
                 { selected: 'GBP' },
                 { class: "form-control", id: "income-currency" } %>
    <small class="text-muted">Select the currency your income is in</small>
  </div>

  <div class="form-group" id="exchange-rate-group" style="display: none;">
    <%= f.label :exchange_rate, "Exchange Rate" %>
    <div style="display: flex; gap: 10px;">
      <div style="flex: 1;">
        <%= f.number_field :exchange_rate, step: 0.0001, min: 0,
                           class: "form-control",
                           placeholder: "e.g., 0.8650",
                           id: "income-exchange-rate" %>
      </div>
      <div id="exchange-rate-hint" style="padding: 0.75rem; background: #f0f4ff; border-radius: 4px; font-size: 0.875rem; color: #667eea;">
        <!-- Will be filled by JavaScript -->
      </div>
    </div>
    <small class="text-muted">Leave blank to use system rate. Format: 1 EUR = X GBP</small>
  </div>

  <div class="form-group">
    <%= f.label :amount_gross, "Gross Amount" %>
    <div style="display: flex; gap: 10px; align-items: center;">
      <%= f.number_field :amount_gross, step: 0.01, min: 0,
                         class: "form-control", required: true,
                         placeholder: "e.g., 50000.00",
                         id: "income-amount-gross" %>
      <span id="currency-symbol" style="min-width: 30px;">£</span>
    </div>
  </div>

  <div class="form-group">
    <%= f.label :amount_tax_taken, "Tax Taken at Source" %>
    <div style="display: flex; gap: 10px; align-items: center;">
      <%= f.number_field :amount_tax_taken, step: 0.01, min: 0, value: 0,
                         class: "form-control",
                         placeholder: "e.g., 10000.00",
                         id: "income-amount-tax" %>
      <span id="currency-symbol-2" style="min-width: 30px;">£</span>
    </div>
  </div>

  <div class="form-group">
    <%= f.label :description, "Description (optional)" %>
    <%= f.text_field :description, class: "form-control",
                     placeholder: "e.g., Main employment, Side business, or source of income" %>
  </div>

  <div class="form-actions">
    <%= f.submit income_source.persisted? ? "Update Income Source" : "Add Income Source",
                 class: "btn btn-primary" %>
    <%= link_to "Cancel", tax_return_income_sources_path(@tax_return),
                class: "btn btn-secondary" %>
  </div>
<% end %>

<script>
  // Exchange rate configuration (from environment)
  const exchangeRates = {
    'EUR': <%= ENV['EUR_TO_GBP_RATE'] || 0.8650 %>,
    'USD': <%= ENV['USD_TO_GBP_RATE'] || 1.2850 %>
  };

  const currencySelect = document.getElementById('income-currency');
  const exchangeRateGroup = document.getElementById('exchange-rate-group');
  const currencySymbol = document.getElementById('currency-symbol');
  const currencySymbol2 = document.getElementById('currency-symbol-2');
  const exchangeRateInput = document.getElementById('income-exchange-rate');
  const exchangeRateHint = document.getElementById('exchange-rate-hint');

  function updateCurrencyDisplay() {
    const currency = currencySelect.value;
    const symbol = currency === 'GBP' ? '£' : currency;

    // Update symbols
    currencySymbol.textContent = symbol;
    currencySymbol2.textContent = symbol;

    // Show/hide exchange rate input
    if (currency === 'GBP') {
      exchangeRateGroup.style.display = 'none';
    } else {
      exchangeRateGroup.style.display = 'block';

      // Show system rate hint
      const systemRate = exchangeRates[currency];
      if (systemRate) {
        exchangeRateHint.innerHTML = `<strong>System rate:</strong> 1 ${currency} = £${systemRate.toFixed(4)}`;
        if (!exchangeRateInput.value) {
          exchangeRateInput.placeholder = `e.g., ${systemRate.toFixed(4)}`;
        }
      }
    }
  }

  currencySelect.addEventListener('change', updateCurrencyDisplay);
  updateCurrencyDisplay(); // Initialize on page load
</script>
